name: Generate Blog Draft

on:
  schedule:
    # Every Monday at 9:00 UTC (adjust to your timezone)
    - cron: '0 9 * * 1'
  
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      force_run:
        description: 'Force generation even if recently run'
        required: false
        default: 'false'

permissions:
  contents: write  # Needed to push commits

jobs:
  generate-draft:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r config/requirements.txt
      
      - name: Select topic
        id: select
        run: |
          python scripts/select_topic.py
          
          # Extract topic info for later steps
          TOPIC_TITLE=$(cat .selected_topic.json | python -c "import sys, json; print(json.load(sys.stdin)['title'])")
          echo "topic_title=$TOPIC_TITLE" >> $GITHUB_OUTPUT
      
      - name: Generate draft
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/generate_draft.py
      
      - name: Commit and push changes
        run: |
          # Configure git
          git config user.name "Blog Automation Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get draft directory for commit message
          DRAFT_DIR=$(ls -t drafts/ | head -n 1)
          
          # Stage changes
          git add drafts/
          git add config/topics.json
          
          # Create meaningful commit
          git commit -m "ðŸ“ Draft: ${{ steps.select.outputs.topic_title }}" \
                     -m "Auto-generated technical blog draft" \
                     -m "" \
                     -m "Draft location: drafts/$DRAFT_DIR" \
                     -m "Generated by: GitHub Actions" \
                     -m "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Push to main
          git push origin main
      
      - name: Summary
        if: success()
        run: |
          echo "âœ… Draft generation complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ steps.select.outputs.topic_title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          DRAFT_DIR=$(ls -t drafts/ | head -n 1)
          echo "**Location:** \`drafts/$DRAFT_DIR\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Send ntfy notification
        if: success()
        run: |
          curl -d "âœ… Blog Draft Generated: ${{ steps.select.outputs.topic_title }}" \
               -H "Title: Blog Automation Success" \
               -H "Priority: high" \
               -H "Tags: white_check_mark,memo" \
               ntfy.sh/flutter-blog-${{ github.repository_id }}
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Draft generation failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details" >> $GITHUB_STEP_SUMMARY